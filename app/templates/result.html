{% extends "base.html" %}
{% block head %}
  <title>Watch - Couchtube</title>
{% endblock %}
{% block content %}
<!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
<!-- <div class="row"> -->
    <iframe id="player" class="player-up" type="text/html"
    src="https://www.youtube.com/embed/{{ episodes[0][3] }}?rel=0&autohide=1&color=red&theme=dark"
    frameborder="0" allowfullscreen></iframe>
<!-- </div> -->
<nav class="navbar navbar-default navbar-fixed-bottom" role="navigation">
  <div class="episode-toggle" role="button"><i id="updown" class="icon-chevron-sign-down icon-large link-tooltip" data-toggle="tooltip" data-placement="top" title="Episode list"></i></div>
  <div class="episode-list" id='{{ seasons|length }}'>
    {% for s in seasons %}
      <span id='{{ s }}-season' class="season-list">
        <span class="season-header" id='{{ s }}'>{{ s }}</span>
        {% for ep in episodes %}
          {% if ep[1] == s %}
            <span id="S{{ ep[1] }}-E{{ ep[2] }}" class="episode-thumb" data-id="{{ ep[3] }}">
              <img src="{{ ep[4] }}" class="episode-video" onError="this.src='static/img/thmb_def-w.svg';">
              <div class="caption">S{{ ep[1] }}-E{{ ep[2] }}</div>
            </span>
          {% endif %}
        {% endfor %}
      </span>
    {% endfor %}
  </div>
</nav>
{% endblock %}
{% block scripts %}
<!-- <script src="static/js/typeahead.js"></script> -->
<script type="text/javascript">
  $(document).ready(function() {
    // Document loaded
    $("body").toggleClass('dark');
    $('.link-tooltip').tooltip();
    $('.episode-toggle').click( function() {
      $(this).parent().find(".episode-list").slideToggle('fast', function() {
        $(this).parent().find("#updown").toggleClass('icon-chevron-sign-down');
        $(this).parent().find("#updown").toggleClass('icon-chevron-sign-up');
        $("#player").toggleClass('player-up');
        $("#player").toggleClass('player-down');
      });
    });
    // Scroll to season
    $('.season-header').click(function() {
      var se = parseInt($(this).attr('id'),10);
      var pos = $('#'+se+'-season').position().left;
      var cpos = $('.episode-list').scrollLeft();
      console.log(se, pos);
      $('.episode-list').animate({scrollLeft: cpos+pos-(se-1)*20}, 'fast');
    });
    // Place season headers
    $('.season-header').each( function() {
      var se = parseInt($(this).attr('id'),10);
      var ns = parseInt($('.episode-list').attr('id'),10);
      var pos = 0;
      if(se > 1) {
        pos = $('.episode-list').outerWidth() - 20*(ns-se+1);
      }
      $(this).css('position', 'fixed');
      $(this).css('left', pos+"px");
    });
    // Switch episode
    $('.episode-video').click( function() {
      var vidId = $(this).parent().attr("data-id");
      $('#player').attr('src',"https://www.youtube.com/embed/"+vidId+"?rel=0&autohide=1&color=red&theme=dark");
    });
    // Track episode scrolling
    $('.episode-list').scroll( function() {
      $('.season-header').each( function() {
        var se = parseInt($(this).attr('id'),10);
        var ns = parseInt($('.episode-list').attr('id'),10);
        var pos = $('#'+se+'-season').position().left;
        var left_lim = (se-1)*20;
        var right_lim = $('.episode-list').outerWidth() - 20*(ns-se+1);
        if(pos <= left_lim) {
          $(this).css('position', 'fixed');
          $(this).css('left', left_lim+"px");
        } else if(pos >= right_lim) {
          $(this).css('position', 'fixed');
          $(this).css('left', right_lim+"px");
        } else {
          // $(this).css('left', pos+"px");
          $(this).css('position', 'static');
        }
      });
    });
  });
</script>
{% endblock %}